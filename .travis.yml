language: ruby
cache:
  bundler: true
  apt: true
git:
  strategy: clone
  depth: 1
  quiet: true
stages:
  - unit_tests
  - integration_tests
  - deployment
  - acceptance_tests
env:
  - DOCKER_COMPOSE_VERSION: 1.8.0
services:
  - docker
before_install:
  - sudo apt-get update
  - sudo apt-get install -o Dpkg::Options::="--force-confold" --force-yes -y docker-engine
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
install:
  - docker-compose build
  - docker-compose up -d
  - docker ps
before_script:
  - docker exec /srv/hycruz/wait-for-services.sh localhost:80 -t 180
  - docker exec /srv/hycruz/wait-for-services.sh db:3306 -t 180
jobs:
  include:
    - name: "unit tests"
      stage: unit_tests
      env:
        - TEST_DIR: unit
        - TEST_BRANCH: unit_test
    - name: "integration tests"
      stage: integration_tests
      env:
        - TEST_DIR: integration
        - TEST_BRANCH: integration_test
    - name: "deployment"
      stage: deployment
      script: bundle exec cap $TRAVIS_BRANCH deploy BRANCH=$TRAVIS_BRANCH
      before_install:
        - openssl aes-256-cbc -K $encrypted_52af377e3440_key -iv $encrypted_52af377e3440_iv
        - in hycruz_deploy_rsa.enc -out hycruz_deploy_rsa -d
